---
- block:
  # This is ugly, but helm module is broken
  - name: Create temporary directory for ingresses
    tempfile:
      path: "/home/{{ master_user }}"
      state: directory
      suffix: _k8s_deps
    register: k8s_deps

  - name: Download ingress-nginx spec
    get_url:
      url: "{{ item.url }}"
      dest: "{{ item.dest }}"
    with_items:
      - { url: 'https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-0.32.0/deploy/static/provider/baremetal/deploy.yaml', dest: '{{ k8s_deps.path }}/ingress-nginx.yaml' }

  - name: Install ingress-nginx repo
    k8s:
      namespace: default
      src: "{{ k8s_deps.path }}/ingress-nginx.yaml"
      state: present

  - name: Upload custom ConfigMap
    copy:
      src: files/nginx-configmap.yml
      dest: "{{ k8s_deps.path }}/nginx-configmap.yaml"

  - name: Apply custom configmap
    k8s:
      namespace: ingress-nginx
      src: "{{ k8s_deps.path }}/nginx-configmap.yaml"
      state: present
  
  always:
    - name: Tempdir cleanup
      file:
        state: absent
        path: "{{ k8s_deps.path }}"

  tags:
    - bootstrap
    - nginx